<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Really Happened – Understanding Complex PTSD</title>
    <meta name="description" content="16-part trauma-informed lecture series and memoir case study by Daniel Bret Lingar. Free nervous system check-in tool.">
    <link rel="icon" href="favicon.ico">
    
    <!-- Social Media Meta Tags -->
    <meta property="og:title" content="What Really Happened – Understanding Complex PTSD">
    <meta property="og:description" content="A raw, working-class journey through Complex PTSD. Memoir + 16 lectures + nervous system tools.">
    <meta property="og:image" content="https://groundedcptsd.com/book-cover-final.jpg">
    <meta property="og:url" content="https://groundedcptsd.com">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ember: '#ea580c',  /* Deep Orange */
                        bronze: '#cd7f32', /* Metallic accent */
                        charcoal: '#0f0f0f', /* Background */
                        surface: '#1f2937'   /* Cards */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0f0f0f; color: #e5e7eb; }
        .section-padding { padding: 5rem 1rem; }
        
        /* Focus styles for accessibility */
        *:focus-visible { outline: 2px solid #ea580c; outline-offset: 4px; }
        
        /* Accessibility Skip Link */
        .skip-link { position: absolute; top: -40px; left: 0; background: #ea580c; color: white; padding: 8px 16px; z-index: 100; transition: top 0.2s; }
        .skip-link:focus { top: 0; }
        
        /* Tool Animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-100 antialiased">
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation -->
    <header class="bg-black/90 backdrop-blur sticky top-0 z-50 border-b border-orange-900/30">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
            <a href="#" class="text-xl md:text-2xl font-black text-ember tracking-tight hover:text-white transition">
                What Really Happened
            </a>
            <nav class="hidden md:flex space-x-8 text-sm font-semibold uppercase tracking-wide">
                <a href="#check-in" class="hover:text-ember transition">Check-In Tool</a>
                <a href="#lectures" class="hover:text-ember transition">Lecture Series</a>
                <a href="#book" class="hover:text-ember transition">The Memoir</a>
                <a href="#pricing" class="hover:text-ember transition">Work With Me</a>
            </nav>
            <button id="menu-btn" class="md:hidden text-ember p-2" aria-label="Toggle menu">
                <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-surface border-b border-orange-900/30">
            <nav class="flex flex-col p-4 space-y-4">
                <a href="#check-in" class="block hover:text-ember">Check-In Tool</a>
                <a href="#lectures" class="block hover:text-ember">Lecture Series</a>
                <a href="#book" class="block hover:text-ember">The Memoir</a>
                <a href="#pricing" class="block hover:text-ember">Work With Me</a>
            </nav>
        </div>
    </header>

    <main id="main-content">
        <!-- Hero Section -->
        <section class="section-padding text-center bg-gradient-to-b from-black to-gray-900 relative overflow-hidden">
            <div class="max-w-5xl mx-auto px-4 relative z-10">
                <h1 class="text-4xl md:text-6xl font-black leading-tight mb-8">
                    If I ever tell you about my past,<br>
                    <span class="text-ember">it’s never because I want you to feel sorry for me,</span><br>
                    but so you can understand why I am who I am.
                </h1>
                
                <!-- Quote Graphic Placeholder -->
                <div class="my-12 relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-ember to-bronze rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <img src="quote-graphic.jpg" alt="Daniel Bret Lingar Quote" class="relative mx-auto rounded-lg shadow-2xl max-w-full md:max-w-2xl border border-gray-800">
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-6">
                    <a href="#check-in" class="px-8 py-4 bg-ember text-white text-lg font-bold rounded hover:bg-orange-700 transition transform hover:-translate-y-1 shadow-lg shadow-orange-900/20">
                        Check In With Your Body
                    </a>
                    <a href="#pricing" class="px-8 py-4 border-2 border-ember text-ember text-lg font-bold rounded hover:bg-ember hover:text-white transition transform hover:-translate-y-1">
                        Get Book + Course
                    </a>
                </div>
            </div>
        </section>

        <!-- Nervous System Check-In Tool -->
        <section id="check-in" class="section-padding bg-gray-900 border-y border-gray-800">
            <div class="max-w-3xl mx-auto px-4">
                <div class="text-center mb-10">
                    <span class="text-bronze font-bold tracking-wider uppercase text-sm">Interactive Tool</span>
                    <h2 class="text-3xl md:text-4xl font-bold mt-2">Where Are You Right Now?</h2>
                    <p class="text-gray-400 mt-4">A moment to pause, notice, and find a tiny step forward.</p>
                </div>

                <!-- Tool Container -->
                <div class="bg-surface rounded-2xl p-6 md:p-8 shadow-2xl border border-gray-700">
                    
                    <!-- Step 1: State -->
                    <div class="mb-10">
                        <h3 class="text-lg font-semibold mb-4 text-gray-200">1. How does your body feel?</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <button type="button" class="state-btn p-4 rounded-xl border border-gray-600 bg-gray-800 hover:bg-gray-750 transition text-left group w-full" data-state="ventral" data-description="Safety & Connection (Ventral Vagal)">
                                <div class="font-bold text-green-400 mb-1">Safe / Connected</div>
                                <div class="text-xs text-gray-400">Calm, curious, grounded, present.</div>
                                <input type="text" class="optional-note mt-3 w-full bg-gray-900 border-none rounded text-xs p-2 text-gray-300 placeholder-gray-600 focus:ring-1 focus:ring-green-500" placeholder="Optional note..." onclick="event.stopPropagation()">
                            </button>

                            <button type="button" class="state-btn p-4 rounded-xl border border-gray-600 bg-gray-800 hover:bg-gray-750 transition text-left group w-full" data-state="sympathetic" data-description="Mobilization (Sympathetic)">
                                <div class="font-bold text-ember mb-1">Mobilized / Anxious</div>
                                <div class="text-xs text-gray-400">Racing heart, irritation, fight/flight.</div>
                                <input type="text" class="optional-note mt-3 w-full bg-gray-900 border-none rounded text-xs p-2 text-gray-300 placeholder-gray-600 focus:ring-1 focus:ring-ember" placeholder="Optional note..." onclick="event.stopPropagation()">
                            </button>

                            <button type="button" class="state-btn p-4 rounded-xl border border-gray-600 bg-gray-800 hover:bg-gray-750 transition text-left group w-full" data-state="dorsal" data-description="Shutdown (Dorsal Vagal)">
                                <div class="font-bold text-blue-400 mb-1">Shutdown / Numb</div>
                                <div class="text-xs text-gray-400">Foggy, disconnected, heavy, invisible.</div>
                                <input type="text" class="optional-note mt-3 w-full bg-gray-900 border-none rounded text-xs p-2 text-gray-300 placeholder-gray-600 focus:ring-1 focus:ring-blue-500" placeholder="Optional note..." onclick="event.stopPropagation()">
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Needs -->
                    <div id="step-2" class="mb-10">
                        <h3 class="text-lg font-semibold mb-4 text-gray-200">2. What might you need? (Select any)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Rest / Sleep</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Water / Food</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Movement</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Quiet</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Connection</span>
                            </label>
                            <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-700 hover:bg-gray-750 cursor-pointer">
                                <input type="checkbox" name="needs" class="form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                                <span class="text-sm text-gray-300">Safety</span>
                            </label>
                        </div>
                        <input type="text" class="optional-note w-full bg-gray-800 border border-gray-600 rounded p-3 text-sm text-gray-200 focus:border-ember focus:ring-1 focus:ring-ember" placeholder="Anything else you need right now?">
                    </div>

                    <!-- Step 3: Tiny Step -->
                    <div class="mb-10">
                        <h3 class="text-lg font-semibold mb-4 text-gray-200">3. One tiny step for right now</h3>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Take 3 deep breaths</button>
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Drink a glass of water</button>
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Step outside</button>
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Text a friend</button>
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Wrap in a blanket</button>
                            <button type="button" class="step-btn px-4 py-2 rounded-full border border-gray-600 text-sm text-gray-300 hover:bg-gray-700 transition">Do nothing at all</button>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="border-t border-gray-700 pt-6">
                        <label class="flex items-start space-x-3 mb-6 cursor-pointer">
                            <input type="checkbox" id="safetyCheckbox" class="mt-1 form-checkbox text-ember rounded bg-gray-900 border-gray-600 focus:ring-ember">
                            <span class="text-xs text-gray-400">
                                I understand this is an educational tool for self-reflection, not a substitute for professional therapeutic or medical advice.
                            </span>
                        </label>

                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="generateBtn" disabled class="flex-1 py-3 px-6 bg-ember text-white font-bold rounded-lg shadow-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex justify-center items-center">
                                Generate Summary
                            </button>
                            <button id="resetBtn" class="py-3 px-6 bg-transparent border border-gray-600 text-gray-400 font-medium rounded-lg hover:bg-gray-800 hover:text-white transition">
                                Reset
                            </button>
                        </div>
                    </div>

                    <!-- Results Area (Hidden by default) -->
                    <div id="resultsDiv" class="hidden mt-8 pt-8 border-t-2 border-dashed border-gray-700 fade-in" aria-live="polite">
                        <h3 class="text-xl font-bold text-center mb-6 text-bronze">Your Check-In Summary</h3>
                        
                        <div id="summary-content" class="bg-gray-50 text-gray-800 rounded-lg p-6 mb-6 font-medium shadow-inner">
                            <div class="mb-4 pb-4 border-b border-gray-200 flex justify-between items-center">
                                <span class="text-sm text-gray-500" id="timestamp"></span>
                                <span class="text-xs font-bold text-gray-600 uppercase tracking-wider">What Really Happened</span>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <span class="block text-xs font-bold text-gray-400 uppercase">State</span>
                                    <div id="state-summary"></div>
                                </div>
                                <div>
                                    <span class="block text-xs font-bold text-gray-400 uppercase">Needs</span>
                                    <div id="needs-summary"></div>
                                </div>
                                <div>
                                    <span class="block text-xs font-bold text-gray-400 uppercase">Tiny Step</span>
                                    <div id="step-summary"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Actions -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button id="copy-btn" class="flex items-center justify-center py-2 px-4 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition text-sm font-medium">
                                Copy to Clipboard
                            </button>
                            <button id="download-btn" class="flex items-center justify-center py-2 px-4 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition text-sm font-medium">
                                Download .txt
                            </button>
                            <button id="print-btn" class="flex items-center justify-center py-2 px-4 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition text-sm font-medium">
                                Print / PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lecture Series -->
        <section id="lectures" class="section-padding bg-black">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <span class="text-bronze font-bold tracking-wider uppercase text-sm">The Curriculum</span>
                <h2 class="text-3xl md:text-5xl font-bold mb-8 mt-2">16-Part Lecture Series</h2>
                <p class="text-xl text-gray-400 mb-12 max-w-3xl mx-auto leading-relaxed">
                    Bridging the gap between raw lived experience and trauma science. <br>For survivors, therapists, educators, and support groups.
                </p>
                
                <div class="grid md:grid-cols-2 gap-12 items-center mb-12">
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition"></div>
                        <img src="curriculum-preview.jpg" alt="Curriculum Preview" class="relative rounded-lg shadow-2xl w-full">
                    </div>
                    <div class="text-left">
                        <h3 class="text-2xl font-bold mb-4 text-white">What's Inside?</h3>
                        <ul class="space-y-3 text-gray-300 mb-8">
                            <li class="flex items-center"><span class="text-ember mr-2">✓</span> The Physiology of Trauma</li>
                            <li class="flex items-center"><span class="text-ember mr-2">✓</span> Mapping Your Nervous System</li>
                            <li class="flex items-center"><span class="text-ember mr-2">✓</span> Breaking the Shame Cycle</li>
                            <li class="flex items-center"><span class="text-ember mr-2">✓</span> Reclaiming Agency & Voice</li>
                            <li class="flex items-center"><span class="text-ember mr-2">✓</span> 12+ Practical Worksheets</li>
                        </ul>
                        <a href="lectures-curriculum.pdf" download class="inline-flex items-center px-8 py-3 bg-gray-800 text-white font-bold rounded border border-gray-600 hover:bg-gray-700 hover:border-white transition">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Download Curriculum PDF
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- The Memoir -->
        <section id="book" class="section-padding bg-gray-900 border-y border-gray-800">
            <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-16 items-center">
                <div class="order-2 md:order-1">
                    <span class="text-bronze font-bold tracking-wider uppercase text-sm">The Case Study</span>
                    <h2 class="text-4xl font-bold mb-6 mt-2">From the Storm to the Fire</h2>
                    <p class="text-lg leading-relaxed text-gray-300 mb-6">
                        This isn't just a story. It's the anchor for the entire course. We analyze Daniel's journey through addiction, poverty, and complex trauma to understand the mechanisms of survival and the hard road to healing.
                    </p>
                    <blockquote class="border-l-4 border-ember pl-4 italic text-gray-400 mb-8">
                        "A gut punch of a memoir… devastating and luminous."
                        <footer class="text-sm font-bold mt-2 text-gray-500">— Reviewer Name</footer>
                    </blockquote>
                    <a href="#pricing" class="text-ember font-bold hover:text-white transition flex items-center group">
                        Read the first chapter
                        <svg class="w-4 h-4 ml-2 transform group-hover:translate-x-1 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                    </a>
                </div>
                <div class="order-1 md:order-2 flex justify-center">
                    <div class="relative w-64 md:w-80">
                        <div class="absolute -inset-2 bg-ember rounded-lg blur opacity-20"></div>
                        <img src="book-cover-final.jpg" alt="From the Storm to the Fire Book Cover" class="relative rounded-lg shadow-2xl transform hover:scale-105 transition duration-500">
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing / Work With Me -->
        <section id="pricing" class="section-padding bg-gradient-to-t from-black to-gray-900">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <h2 class="text-4xl font-bold mb-12">Ways to Walk This Path</h2>
                
                <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <!-- Digital Bundle -->
                    <div class="bg-surface p-8 rounded-2xl border border-gray-700 hover:border-ember transition relative overflow-hidden group">
                        <div class="absolute top-0 right-0 bg-gray-700 text-xs font-bold px-3 py-1 rounded-bl-lg">SELF-PACED</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Book + Lecture Bundle</h3>
                        <p class="text-gray-400 text-sm mb-6">Everything you need to start today.</p>
                        <p class="text-5xl font-black mb-6 text-bronze">$47</p>
                        
                        <ul class="text-left space-y-4 text-gray-300 mb-8 border-t border-gray-700 pt-6">
                            <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Full Digital Memoir (PDF/ePub)</li>
                            <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> All 16 Lecture Transcripts</li>
                            <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Printable Worksheets & Exercises</li>
                            <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Lifetime Updates</li>
                        </ul>
                        
                        <a href="mailto:daniel@groundedcptsd.com?subject=Book+%2B+Lecture+Bundle" class="block w-full py-4 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-600 transition">
                            Join Waitlist
                        </a>
                    </div>

                    <!-- Mentorship -->
                    <div class="bg-ember p-8 rounded-2xl shadow-xl transform md:-translate-y-4 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-white text-ember text-xs font-bold px-3 py-1 rounded-bl-lg">POPULAR</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Live Group Mentorship</h3>
                        <p class="text-orange-100 text-sm mb-6">Deep work in a safe container.</p>
                        <p class="text-5xl font-black mb-6 text-white">$197<span class="text-xl font-medium">/mo</span></p>
                        
                        <ul class="text-left space-y-4 text-white mb-8 border-t border-orange-500 pt-6">
                            <li class="flex items-start"><span class="text-black mr-2">✓</span> <strong>Includes everything in Bundle</strong></li>
                            <li class="flex items-start"><span class="text-black mr-2">✓</span> Weekly Live Q&A with Daniel</li>
                            <li class="flex items-start"><span class="text-black mr-2">✓</span> Private Community Access</li>
                            <li class="flex items-start"><span class="text-black mr-2">✓</span> Guided Polyvagal Practices</li>
                        </ul>
                        
                        <a href="mailto:daniel@groundedcptsd.com?subject=Group+Mentorship" class="block w-full py-4 bg-white text-ember font-bold rounded-lg hover:bg-gray-50 transition shadow-lg">
                            Apply for Spot
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-black py-12 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-sm text-gray-500">
            <div class="mb-4 md:mb-0">
                <p>&copy; 2025 What Really Happened</p>
                <p class="mt-1">groundedcptsd.com</p>
            </div>
            <div class="flex space-x-6">
                <a href="#" class="hover:text-white transition">Privacy</a>
                <a href="#" class="hover:text-white transition">Terms</a>
                <a href="mailto:daniel@groundedcptsd.com" class="hover:text-white transition">Contact</a>
            </div>
        </div>
    </footer>

    <!-- LOGIC: Enhanced Check-In Tool (Theme-Matched for Dark Mode) -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. State Management ---
            let currentSummaryData = null;
            let selectedState = null;
            let selectedNeeds = [];
            let selectedStep = '';
            let exportInProgress = false;

            // --- 2. DOM Cache & Validation ---
            const elements = {};
            const elementIds = [
                'generateBtn', 'safetyCheckbox', 'resultsDiv', 'summary-content',
                'resetBtn', 'state-summary', 'needs-summary', 'step-summary', 'timestamp',
                'copy-btn', 'print-btn', 'download-btn'
            ];

            elementIds.forEach(id => {
                elements[id] = document.getElementById(id);
            });

            elements.needsNoteInput = document.querySelector('#step-2 .optional-note');
            elements.stateButtons = document.querySelectorAll('.state-btn');
            elements.stepButtons = document.querySelectorAll('.step-btn');
            elements.needsCheckboxes = document.querySelectorAll('#step-2 input[type="checkbox"]');

            if (!elements.generateBtn || !elements.safetyCheckbox) return;

            // --- 3. Event Listeners ---
            function init() {
                if (elements.stateButtons) {
                    elements.stateButtons.forEach(btn => btn.addEventListener('click', handleStateSelection));
                }
                if (elements.needsCheckboxes) {
                    elements.needsCheckboxes.forEach(cb => cb.addEventListener('change', handleNeedsSelection));
                }
                if (elements.stepButtons) {
                    elements.stepButtons.forEach(btn => btn.addEventListener('click', handleStepSelection));
                }
                elements.safetyCheckbox.addEventListener('change', handleSafetyToggle);
                elements.generateBtn.addEventListener('click', handleGenerate);
                elements.resetBtn?.addEventListener('click', handleReset);
                document.addEventListener('click', handleExportClicks);
                
                // Mobile Menu
                document.getElementById('menu-btn')?.addEventListener('click', () => {
                    document.getElementById('mobile-menu').classList.toggle('hidden');
                });
            }

            // --- 4. Logic Handlers (Theme Aware) ---
            function handleStateSelection(e) {
                if(e.target.tagName.toLowerCase() === 'input') return;
                const btn = e.currentTarget;
                
                // Reset styling (Dark Mode Friendly)
                elements.stateButtons.forEach(b => {
                    b.classList.remove('ring-2', 'ring-ember', 'ring-green-500', 'ring-blue-500', 'bg-gray-700');
                    b.classList.add('bg-gray-800', 'border-gray-600');
                });
                
                // Active Styling
                const state = btn.dataset.state;
                let activeRing = 'ring-ember';
                if (state === 'ventral') activeRing = 'ring-green-500';
                if (state === 'dorsal') activeRing = 'ring-blue-500';

                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-gray-700', 'ring-2', activeRing);
                
                selectedState = {
                    state: state,
                    description: btn.dataset.description,
                    note: btn.querySelector('.optional-note')?.value.trim() || ''
                };
                updateGenerateButtonState();
            }

            function handleNeedsSelection(e) {
                const label = e.target.nextElementSibling.textContent.trim();
                if (e.target.checked) selectedNeeds.push(label);
                else selectedNeeds = selectedNeeds.filter(n => n !== label);
            }

            function handleStepSelection(e) {
                elements.stepButtons.forEach(b => {
                    b.classList.remove('bg-gray-200', 'text-gray-900', 'font-bold');
                    b.classList.add('text-gray-300', 'border-gray-600');
                });
                const btn = e.currentTarget;
                btn.classList.remove('text-gray-300', 'border-gray-600');
                btn.classList.add('bg-gray-200', 'text-gray-900', 'font-bold');
                selectedStep = btn.textContent.trim();
            }

            function handleSafetyToggle() {
                const isEnabled = elements.safetyCheckbox.checked;
                const els = document.querySelectorAll('#check-in button:not(#resetBtn), #check-in input:not(#safetyCheckbox)');
                els.forEach(el => el.setAttribute('aria-disabled', !isEnabled));
                updateGenerateButtonState();
            }

            function updateGenerateButtonState() {
                const isValid = elements.safetyCheckbox.checked && selectedState;
                elements.generateBtn.disabled = !isValid;
                if(isValid) {
                    elements.generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    elements.generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // --- 5. Generate ---
            function handleGenerate(e) {
                e.preventDefault();
                if(elements.generateBtn.disabled) return;
                
                elements.generateBtn.innerHTML = 'Generating...';
                setTimeout(() => {
                    generateContent();
                    elements.generateBtn.innerHTML = 'Generate Summary';
                }, 400);
            }

            function generateContent() {
                const now = new Date();
                const ts = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                // Capture latest note from active button
                const activeBtn = document.querySelector('.state-btn.ring-2');
                if(activeBtn) selectedState.note = activeBtn.querySelector('.optional-note')?.value.trim() || '';
                const userNeedsNote = elements.needsNoteInput?.value.trim() || '';

                const stateText = `Right now, you're noticing sensations that align with ${selectedState.description}.`;
                const needsText = selectedNeeds.length > 0 ? `You identified possible needs: ${selectedNeeds.join(', ')}.` : "You didn't select any specific needs.";
                const stepText = selectedStep ? `One tiny step: ${selectedStep}.` : "No specific step chosen.";

                // HTML Display
                elements.stateSummary.innerHTML = escapeHTML(stateText) + (selectedState.note ? `<br><em class="text-gray-500 mt-1 block">Note: "${escapeHTML(selectedState.note)}"</em>` : '');
                elements.needsSummary.innerHTML = escapeHTML(needsText) + (userNeedsNote ? `<br><em class="text-gray-500 mt-1 block">Note: "${escapeHTML(userNeedsNote)}"</em>` : '');
                elements.stepSummary.textContent = stepText;
                elements.timestamp.textContent = ts;

                // Export Data
                currentSummaryData = {
                    plainText: `Check-In Summary\nDate: ${ts}\n\nState: ${stateText}\n${selectedState.note ? `Note: ${selectedState.note}\n` : ''}\nNeeds: ${needsText}\n${userNeedsNote ? `Note: ${userNeedsNote}\n` : ''}\nStep: ${stepText}\n\nGenerated via What Really Happened`,
                    timestamp: ts
                };

                elements.resultsDiv.classList.remove('hidden');
                elements.resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // --- 6. Export ---
            function handleExportClicks(e) {
                if(!currentSummaryData) return;
                const copy = e.target.closest('#copy-btn');
                const print = e.target.closest('#print-btn');
                const dl = e.target.closest('#download-btn');
                if(copy) handleCopy(copy);
                if(print) handlePrint();
                if(dl) handleDownload(dl);
            }

            async function handleCopy(btn) {
                try {
                    await navigator.clipboard.writeText(currentSummaryData.plainText);
                    showFeedback(btn, true, 'Copied!');
                } catch(e) {
                    fallbackCopy(currentSummaryData.plainText);
                    showFeedback(btn, true, 'Copied!');
                }
                setTimeout(() => showFeedback(btn, false, 'Copy to Clipboard'), 2000);
            }

            function handlePrint() {
                const win = window.open('', '_blank');
                if(win) {
                    win.document.write(`<html><body style="font-family:sans-serif;padding:2rem;"><h1>Check-In Summary</h1>${elements.summaryContent.innerHTML}</body></html>`);
                    win.document.close();
                    win.print();
                }
            }

            function handleDownload(btn) {
                const blob = new Blob([currentSummaryData.plainText], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `checkin-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showFeedback(btn, true, 'Saved!');
                setTimeout(() => showFeedback(btn, false, 'Download .txt'), 2000);
            }

            function handleReset() {
                if(!confirm('Clear check-in?')) return;
                selectedState = null; selectedNeeds = []; selectedStep = ''; currentSummaryData = null;
                elements.stateButtons.forEach(b => {
                    b.classList.remove('ring-2', 'ring-ember', 'ring-green-500', 'ring-blue-500', 'bg-gray-700');
                    b.classList.add('bg-gray-800', 'border-gray-600');
                    b.querySelector('.optional-note').value = '';
                });
                elements.needsCheckboxes.forEach(cb => cb.checked = false);
                elements.stepButtons.forEach(b => {
                    b.classList.remove('bg-gray-200', 'text-gray-900', 'font-bold');
                    b.classList.add('text-gray-300', 'border-gray-600');
                });
                if(elements.needsNoteInput) elements.needsNoteInput.value = '';
                elements.resultsDiv.classList.add('hidden');
                updateGenerateButtonState();
            }

            // Utils
            function escapeHTML(str) { return str.replace(/[&<>'"]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"': '&quot;'}[t])); }
            function fallbackCopy(text) { const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
            function showFeedback(btn, success, msg) {
                if(success) { btn.textContent = msg; btn.classList.add('bg-green-200', 'text-green-800'); }
                else { btn.innerHTML = msg; btn.classList.remove('bg-green-200', 'text-green-800'); }
            }

            init();
        });
    </script>
</body>
</html>
